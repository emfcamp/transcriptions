Everything you never wanted to know about smart lightbulbs by Matthew Garrett.
>> We're ready for a the next talk which is Matthew Garrett who will talk to us about everything you need to know about smart lightbulbs. Thank you, Matthew! [Applause]. 
>> It's a real pleasure to be here. I haven't been to EMF Camp before but I'm enjoying it a great deal so far. I work on various bits of computer security stuff but I'm going to be talking to you about lightbulbs which are largely a hobby I have which sounds a little bit strange but I spend a lot of time taking smart lightbulbs and other IoT devices, reverse-engineering them working out if there is a terrifying security issue with them, discovering largely that there is, and then ... gin! My slides are of very poor quality. I will try to make up with quantity. I will be moving quite quickly. In the past, there was a time when dinosaurs roam the earth and there were very few lightbulbs. We will ignore that! In the 18th century, people start doing interesting things with electricity. At some point during this time, people in the if you heat something, it glows, and, if you pass electricity through something, it can heat up. And, then, well, gosh, if we pass enough electricity through this large lump of platinum, then it produces light which is great. Thankfully, this approach was not evolved into too much detail because being around hot lumps of platinum that gradually evaporate means it's not wonderful for your health. In the 19th century we get to the point we get the lightbulb is invented by a lot of people simultaneously. A lot of people build lightbulbs. A lot of people try to improve lightbulbs. We go through various stages - obviously Edison's approach arguably winning because of him building an entire network of components that allows you to build your own from scratch city lighting system. Around this time, we are still using carbon filaments. The problem with those is they don't last that long. The carbon that boils off sticks to the inside of the bulb, and your bulbs get progressively darker until they stop working entirely. We moving on to having tungsten filaments instead. This is better. This is what modern incandescent bulbs are waste on. You have a filament that does gradually evaporate and cover the bulb, some reduction of output, but overall, the idea is that you put 40 or more was the through some tungsten inside a bulb, and then light comes out. People attempting to fix the lifetime issue as the filaments evaporates, it gets weaker, and then eventually it snaps. Realise, if you fill the bulb with halogen, as the tungsten evaporates. You get the cycle where the bulb doesn't deposit its filament. You need to run the halogen bulbs a couple of hundred degrees hotter than non-halogen bulbs so they consume even more power. The basic problem we have at the moment is these home-lighting systems take a lot of power, and they're also emitting a lot of infrared, which is not what we generally want bulbs for. In the 1990s and early 2000s, we start to go into the world of compact fluorescent lighting which is kind of terrible because they look ugly, and they take time to warm up. And they contain are a whole bunch of toxic shit. Then we move on to LEDs where things start getting interesting. Now we have LEDs, you also need to be an LED bulb to work a moderate quantity of electronics on to the aborted. Once you start putting electronics into the lightbulb, you might as well make it do more interesting things as well. This is when we started thinking about smart lighting really becoming a thing although it is not directly linked to LED bulbs. How many of you remember the annoying adverts for X10 home automation stuff that was over the internet for a while? Some of you, good. Not a horrible dream! X10 has the magical ability to multiplex various control signals over the power line so you can use it to control systems remotely, and okay, and then you can connect it to the internet, and then control your lights by using the internet. This was magical, more recently, we also have smart switches which you replace the switch in your wall with something that speaks a network protocol, and then that controls the lighting. We're not going to be talking about any of that stuff because smart switches are not smart lightbulbs. They're much interesting. Smart lightbulbs speak to a network themselves. What that network is varies massively. In video nation is really not the right word, but there a lot of people trying new things. Innovation implies that maybe you build something better rather than merely different. Not so much here. So there's a variety of protocols. There's Z Wave which is a mesh networking protocol in the 2.4 gigahertz range which allows a variety of different devices to form a mesh network inside your home. Advantage of having a mesh network is that you don't need to have your internet stuff - you don't need Wi-Fi to reach your entire home, as long as each bulb is sufficiently close to another club, then you're able to get your signal through the mesh all the way through to the device that you actually want to be talking to. Zigbee is a mesh networking protocol that supports a variety of devices. Zigbee, the end using between Z Wave is uninteresting. They work on the same protocols, they have roughly the same end effect. Z-Wave is more in the enthusiast space compared to Zigbee which is a lot of people who know what Z-Wave and Zigbee are, prefer Z-Wave. People who don't know the difference generally end up with Zigbee because those are things that you buy in boxes that don't have the words Zigbee. Obviously, because people have Wi-Fi networks and people don't have Zigbee networks. Zigbee does require, like Z-wave requires a bridge between your IP network. Most computers do not have Zigbee radios built into them. Using Wi-Fi instead means you don't need the additional hardware. With Wi-Fi - everything needs to be in range, and the devices need to be a little more complex because they need a full Wi-Fi chipset which is a harder protocol to implement than Zigbee and Z-Wave are. Finally, we also have Bluetooth, mostly Bluetooth low energy. This is convenient because your phones speak it, it's relatively low power, but it is less than Wi-Fi. You can build Bluetooth low-energy bulbs for a slightly lower price point than a Wi-Fi bulb, and you don't need a hub. The downside is that Bluetooth can only have a single device secretary connecting, a single device control you're trying to control at once. You can't have multiple people in the home simultaneously changing your bulb status. And, of course, there are bulbs that use something entirely custom. There's a whole bunch you have stuff that's generally referred to as I think "limitless LED" which uses some custom with 2.4 gigahertz thing, but someone reverse-engineers it, and there's a web page about it. In itself, not particularly interesting. But why would you want to use a smart bulb in the first place? Why do we want to make these things that are supposed just help us function in our homes when it's dark intelligent? One thing is they're dimmable. Dimming LED bulbs otherwise is possible but traditional dimmers generally don't work well with LED bulbs. You need to make sure that Euro- LED bulb is compatible with your dimmer. There are a variety of newer intelligent dimming switches which do a better job of this but then you need to make sure your bulbs are compatible with that. Otherwise, buy bulbs capable of dimming themselves, and the problem goes away. You have colour-changing bulbs which is wonderful for parties, I guess. I don't know. I  never really used this much. There is the more useful aspect of colour changing which is being able to change the colour temperature. You can have a bulb at various points in the day has a different colour temperature output. So, as it gets towards night, you can change to a redder, less blue glow, wake up with a more blue glow that encourages you to be active. You can go to sleep when everything is red-shifted instead. Reacting to external events, like ambient light can be used to control the brightness of your bulbs. So, instead of just turning your bulbs on when it starts getting dark, you can gradually have them ramp up. And only produce as much light as it is necessary for you to see the things you want to see. You can reduce your power consumption to an extent, or based on time of day, you can have different outputs. If you want, you can also do things like, this stock price influences the colour of the lightbulb for when you want to be unhappy about the state of the world. You can control smart bulbs from your phone typically which is great when you go out and realise that you forgot to turn the lights on, or when you're come back and you want to turn the lights on before you get home. You can control by shouting at some sort of voice-control device which means if you wake up and cover that you've fallen asleep sitting bolt upright and the lights are on, you can mumble incoherently and the lights will turn off which fixes one of these problems. You can compensate for annoying light set-ups one I have in every room of my flat has a light switch the that controls one socket at the far end of the room, and I'm supposed to plug a lamp in that socket, and there's no way there's a single lamp in that corner of the room will light enough the room. It allows me to bootstrap enough lights to find the other lights and turn them on. [Laughter]. And then, do that in reverse, which means that my lights get turned off while I'm standing next to the front door which is not where I sleep. Anyway, smart bulbs allow you to avoid various very, very first-world problems! [Laughter]. If you take a smart bulb and you pull it apart, like I'm sure many of you would have either done or would like to do, you find first of all a plastic diffuser, the outer surface of the bulb. This is necessary because LEDs are not a broad direction. You want something that is able to hide the fact that you have a small number of point sources inside the bulb, and spread that light out more widely. You have the LEDs themselves, obviously. You have a heat sink, because, while LEDs are low power compared to incandescent ones. They got hot, and you need to conduct the heat away rather than radiate it away. You have a radio, obviously. You need some sort of communications method. You have a controller, the controller is sometimes integrated with the radio. The controller is what it able to take the commands, interpret them, and then do something useful with them as a result. You have a driver, because you need something that is able to take 110 to 230 volts AC and turn that into what the bulbs actually republic at, and able to control the brightness of them. The brightness of LEDs, you have two real options. You can drop the current, but then you run into weirdnesses about LEDs are most efficient at a particular power draw, so, alternatively, you can do pulse-width modulation, you turn them on and off quickly, and some people get angry at you because they can see the flickering. Some of these bulbs - so the driver is responsible for handling that actual aspect of things. Some of these bulbs also contain a speaker. The speaker is normally an entirely separate Bluetooth audio device not integrated with the rest of the bulb's functionality in any way. The bulbs that you sometimes see that they have a built-in speaker and they will change colour in response to the music, your phone is playing the music to the speaker, and then your phone is also analysing the music, and is independently sending commands telling the bulb to change colour. Obviously. Some bulbs are sitting there with green LEDs, blue, reds, and  sometimes, they're red, yellow, and blue rather than red, green, and blue. Some have red, green, blue, and also white. The initial question is you've got red, green, and blue, and we all know that red, green, and blue is enough to make white. Why do you want also to have white LEDs? The that white light is quite difficult. If you want to be able to have your red, green, and blue LEDs produce white light that feels natural, they need to be very well balanced in terms of their output. And the problem is that LEDs from different batches are not particularly consistent in their response curve in terms of emitted light versus power put into them, so, unless you're calibrating your bulbs with every batch, different bulbs will be different shades of white. And some will not be terribly convincingly white at all. If you just turn the red, green, and blue on, you will get something that is either significantly red or blue, or a significantly green.  -- significantly.  -- sickly. Wide LEDs are also bright which means your bulb's lumen statement, how good is this bulb in terms of its power sculling, sounds a lot better. Yes, if this is an 8-watt bulb was that's 600lumens, and you find that is only true for the white LEDs, and the coloured aren't anywhere near that bright, and, if you drive them simultaneously, you're outside your thermal budget, and your bulb catches fire. So a lot of these cheaper bulbs will have high sticker values for their brightness but that is only through if they're in white mode, and then you're not able to to do any sort of temperature-shifting in terms of the colour output because you can't turn the RGB LEDs on at the same time as the white LEDs. In some cases, the more you pay in this this space, you do actually get better bulbs as a result. Ed  a friend had ... and I was impressed. I thought this is clearly the future. This is far more money than I want to spend. I have at this time spent significantly more than the coast of any number of fill ... . And, gracing Python libraries for communicating with those involves, which involved reverse-engineering the protocols. So, quick, just, side note, I'm going to use the word "Android" in a moment which is going to mean that I'm obliged to tell you that I do work for Google but not on Android, and this is not a sales presentation! Also, I'm not representing my employers. This is the only use of the word "Android". If you have an Android phone, if you go into the developer options, then there's an option for HCI debugging. If you turn that on, all the Bluetooth traffic your phone produces gets dropped into a file on the slash SD card partition. You can copy it off your phone, and you have the full Bluetooth log of communications, you can analyse that and see what the app on your phone is doing with the bulb, and you can analyse that, and, in some cases, you end up discovering it basically sends four bytes - one for green, red, blue, and white. Then, that's it. If you then want to implement that, you just do some code that sends the same things. Everything's great. Bulbs that are doing Wi-Fi, you can use TCP dump. For that you need a routed device. Just throw those dumps into Wireshark, stare at them for a while - stare at them for a while, consume gin, and you end up with a library to communicate with the bulbs without kneeing to use the vendor's code in any way. That way, you can integrate it with your own control system. In the process of doing this, you may discover some strange things. For instance, there's a variety of bulbs that are produced by the same company but which are - sorry, the control electronics are produced by the same company but a large number of companies rebrand and resell them. Where the initial network set-up is done by sending them AT commands. One of the AT commands you send is to configure the cloud service that you can use to control the bulb when you're outside your home which, in terms of whether that's authenticated or not, is entirely up to whoever's running that service. Some of them not really authenticated as such that you're able to contact the cloud service, brute-force your way through every possible bulb ID, find out which ones respond to commands, and then turn them on and off. I should make it clear I've not done this! [Laughter]. In most cases, the surrender has probably done - the vendor has done better than. In most cases, it's probably fine. It's not always fine. The set of bulbs I first bought and the worst, they've made two "i"s, and they haven't made them before. It came with a hub which you plugged into your network. There's a button for physical presence authentication. This allows you to ensure that anyone who is going to be able to control the bulbs was at some point in physical proximity to the bulbs, like inside the house. You press the button, your phone pairs with the - exchanges credentials with the hub, and then you're able to control the hub. The button does nothing. If you send the "Hi, I would like to communicate with you command" to the broadcast address, it says, "Yes." Regardless of whether or not the button's been pressed. There were no credentials for the cloud's communication. You could contact the cloud service and then control anyone else's devices. My favourite part is that it was the hub was running a Haydn Wi-Fi network with a DHCP server, so, if you knew someone had one of these, you just needed to talk up and try to connect to the iRainbow network, and you would be authenticated and connected to this device, which was running a telnet demon, admin/admin. You could plug it in, and minimum nearby was able to access your home network by just bouncing through this insecure twice. So, I did work out the protocol for the commands. One of the commands caused the bulb to start flickering at somewhere a little worryingly close to 8 Hertz. That was not really good. Compared to that, we have the Philips. I do not have a business relationship with them. It has a button that does something. You press the button and you're able to authenticate against the device. If you don't, you don't. Every device has a unique cryptographic ID. So you can't even build something that pretends to be someone else's hue hub. Each hub has a unique photographic ID - cryptographic ID, and, amazingly, this cryptographic ID gets regenerated when you do a factory reset. If you do that, all existing credentials are gone forever. There's nothing to do with the fact that you previously knew the credentials, someone else does the device, does a reset - gone. The  the other nice thing about hue, as I mentioned, they solved the RGBW problem by using red, yellow, and blue LEDs which meant they could get really nice whites, and they were very good at calibrating the LEDs so they were actually white. The downside was you couldn't really do green. Because there was no green. But the  more recent ones ars a good at doing white and green. Compared to the iRainbow, - unfortunately, talking about security work I did not do. People far smarter than me did this. The bulbs turned out to be side-channel attacks by measuring accurately the power consumption of the bulb, you could infer what the CPU on the bulb was doing. Which meant that researchers were able to extract the AES key that was used to decrypt and verify firmware updates. Now, the obvious problem here is that AES is used for encryption and decryption. Don't do this. Use RSA or something which has a public/private split. That's the only way you can extract from the bulb is a public key. There's a hint in the name. You're not gaining anything by doing that. The reason they do AES is that RSA is more computationally expensive, and okay, we don't want to push RSA on to a device that doesn't have much computation al ability. The same researchers also discovered how to take over bulbs. Now, being able to productive modified firmware, having the firmware encryption key is not too much of a problem, because the download path for the firmware is still protected by SSL, and the bulbs will not accept firmware updates unless you're on the same Zigbee network as those bulbs are, and it's not possible to join the same Zigbee network as the bulbs without physical presence. Reauthenticating requires close physical locality. The bulbs will look at a request to join your network and will check that the signal is sufficiently strong that you must be very close to the bulb, and will use that as a way of saying, "Okay, I'm not going to join this network because you're too far away." Unfortunately, the command to trigger a factory reset of the bulbs did not require any physical proximity, and, once you do a factory reset of the bulbs, they will join the first network that asks them to join. So, the researchers were able to demonstrate that they could send a factory reset command to a bulb, get the bulb to join their network, and then flash their firmware on to the bulb. So that he did did. They did that with firm wear capable of finding any other nearby bulbs and doing the same thing to them. And, because why not, you're going this far, you're already going to publish a paper that's going to suggest that we are one lightbulb away from the entire internet infrastructure being taken down, they did this flying a drone outside an office window! [Laughter]. So the fun thing about the - the other fun thing about these bulbs is how you do initial set up. For Zigbee and Z-Way devices, it's done by the protocol. It's not easy to attack unless you're setting up your own network. Bluetooth, it is just a nice - the device is discoverable, you connect to it, you potentially have some sort of initial authentication set-up such that you're now the only twice that can talk to the bulb, and you need to do a factory reset to - because there's now a shared secret between you and the bulb. Wi-Fi, you need some way of telling its house guest on to your network. The standard way of doing this is that the bulb comes up running an succeed access point. You connect to the access point and send it information about your network. You can have the bulb scan true frequency ranges looking for - when you're running an encrypted Wi-Fi network, you can still see packet length, so, how about if you just encode the network credentials by sending packets of different lengths, blast those on to the network in multi-cast, and then be - and then the bulb scans through the Wi-Fi ranges looking for a network doing this, and then scrapes the credentials out that way? That's the thing. So, obviously, a lot of these bulbs are running terrible firmware insecure, trying to phone home to places you would rather your bulb wouldn't phone home to. Is there a where way of buying the expensive bulbs? Many of the cheap bulbs are based on the Expressiv8286. Of course there are headers on them, you can build a Pogo pin board and reflash them with free software firmware which you can get from these locations. And these bulbs then running this firmware expose all the control for the bulb over standard interfaces. You can use MQQT which is a home automation framework. Obviously, if you do this, take care not to actually run your bulbs in a way that results in them becoming too hot and catching fire, because if you do, it's your fault, not mine, not the people who wrote that firmware. That is everything I'm going to tell you about bulbs, unless you have questions about bulbs. Applause applause. 
FLOOR:  Did you play around with the lightbulbs that are on 433 megahertz? 
>> No, I did not look at anything that was in the sort of custom range there. Sorry. 
>> Okay, thanks. 
FLOOR:  Did you ever find anything that was actively malicious, not authenticated and running telnet but deliberately doing this.
>> Thankfully, I've not found any lightbulbs that are actively malicious! [Laughter]. Okay, that that case ... oh, you had one. Thank you! [Applause]. 